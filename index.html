<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Show Diff Widget</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            width: 100%;
        }

        .widget-container {
            width: 100%;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .control-panel {
            margin-bottom: 16px;
            padding: 12px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-right: 8px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .diff-container {
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .diff-header {
            padding: 12px 16px;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
            color: #495057;
        }

        .diff-content {
            padding: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-x: auto;
        }

        .diff-line {
            display: flex;
            min-height: 20px;
            padding: 2px 0;
        }

        .line-number {
            min-width: 50px;
            padding: 0 12px;
            text-align: right;
            color: rgba(27,31,35,0.3);
            user-select: none;
            flex-shrink: 0;
        }

        .line-content {
            flex: 1;
            padding: 0 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .diff-line.added {
            background: #e6ffed;
        }

        .diff-line.added .line-content {
            color: #24292e;
        }

        .diff-line.added::before {
            content: '+';
            color: #22863a;
            padding: 0 8px;
            font-weight: bold;
        }

        .diff-line.removed {
            background: #ffeef0;
        }

        .diff-line.removed .line-content {
            color: #24292e;
        }

        .diff-line.removed::before {
            content: '-';
            color: #d73a49;
            padding: 0 8px;
            font-weight: bold;
        }

        .diff-line.unchanged {
            background: white;
        }

        .diff-line.unchanged::before {
            content: ' ';
            padding: 0 8px;
        }

        .empty-state {
            padding: 40px;
            text-align: center;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .status-message {
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 4px;
            font-size: 14px;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .loading {
            padding: 20px;
            text-align: center;
            color: #6c757d;
        }

        .diff-stats {
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
            color: #495057;
        }

        .diff-stats span {
            margin-right: 16px;
        }

        .added-count {
            color: #28a745;
            font-weight: 600;
        }

        .removed-count {
            color: #dc3545;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="control-panel">
            <button id="insertBtn" class="btn btn-primary">ğŸ“ æ’å…¥å¯¹æ¯”æ¨¡æ¿</button>
            <button id="refreshBtn" class="btn btn-success">ğŸ”„ åˆ·æ–°å¯¹æ¯”</button>
        </div>
        
        <div id="statusMessage"></div>
        
        <div class="diff-container">
            <div class="diff-header">å·®å¼‚å¯¹æ¯”ç»“æœ</div>
            <div id="diffContent" class="diff-content">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“Š</div>
                    <p>ç­‰å¾…åŠ è½½å¯¹æ¯”æ•°æ®...</p>
                    <p style="font-size: 12px; color: #adb5bd;">è¯·åœ¨æ­¤æŒ‚ä»¶ä¸Šæ–¹æ’å…¥å¯¹æ¯”æ¨¡æ¿æˆ–æ‰‹åŠ¨åˆ›å»ºåŒ…å«å·¦å³ä»£ç å—çš„è¶…çº§å—</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è·å–æŒ‚ä»¶æ‰€åœ¨å—çš„ID
        const widgetId = window.frameElement?.parentElement?.parentElement?.dataset?.nodeId;
        const API_BASE = 'http://127.0.0.1:6806';

        // ç®€å•çš„diffç®—æ³•å®ç°
        function computeDiff(text1, text2) {
            const lines1 = text1.split('\n');
            const lines2 = text2.split('\n');
            const diff = [];
            
            // ä½¿ç”¨æœ€é•¿å…¬å…±å­åºåˆ—(LCS)ç®—æ³•çš„ç®€åŒ–ç‰ˆæœ¬
            const lcs = longestCommonSubsequence(lines1, lines2);
            
            let i = 0, j = 0, lcsIndex = 0;
            
            while (i < lines1.length || j < lines2.length) {
                if (lcsIndex < lcs.length && i < lines1.length && lines1[i] === lcs[lcsIndex]) {
                    // æœªæ”¹å˜çš„è¡Œ
                    diff.push({ type: 'unchanged', content: lines1[i], oldLine: i + 1, newLine: j + 1 });
                    i++;
                    j++;
                    lcsIndex++;
                } else if (i < lines1.length && (lcsIndex >= lcs.length || lines1[i] !== lcs[lcsIndex])) {
                    // åˆ é™¤çš„è¡Œ
                    diff.push({ type: 'removed', content: lines1[i], oldLine: i + 1, newLine: null });
                    i++;
                } else if (j < lines2.length) {
                    // æ–°å¢çš„è¡Œ
                    diff.push({ type: 'added', content: lines2[j], oldLine: null, newLine: j + 1 });
                    j++;
                }
            }
            
            return diff;
        }

        // æœ€é•¿å…¬å…±å­åºåˆ—ç®—æ³•
        function longestCommonSubsequence(arr1, arr2) {
            const m = arr1.length;
            const n = arr2.length;
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
            
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (arr1[i - 1] === arr2[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                    } else {
                        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                    }
                }
            }
            
            // å›æº¯æ‰¾åˆ°LCS
            const lcs = [];
            let i = m, j = n;
            while (i > 0 && j > 0) {
                if (arr1[i - 1] === arr2[j - 1]) {
                    lcs.unshift(arr1[i - 1]);
                    i--;
                    j--;
                } else if (dp[i - 1][j] > dp[i][j - 1]) {
                    i--;
                } else {
                    j--;
                }
            }
            
            return lcs;
        }

        // æ¸²æŸ“diffç»“æœ
        function renderDiff(diffResult) {
            const container = document.getElementById('diffContent');
            
            if (diffResult.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âœ…</div>
                        <p>ä¸¤æ®µä»£ç å®Œå…¨ç›¸åŒ</p>
                    </div>
                `;
                return;
            }

            // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            const stats = diffResult.reduce((acc, line) => {
                if (line.type === 'added') acc.added++;
                if (line.type === 'removed') acc.removed++;
                return acc;
            }, { added: 0, removed: 0 });

            let html = `
                <div class="diff-stats">
                    <span class="added-count">+${stats.added} æ–°å¢</span>
                    <span class="removed-count">-${stats.removed} åˆ é™¤</span>
                </div>
            `;

            diffResult.forEach(line => {
                const lineNum = line.oldLine || line.newLine || '';
                html += `
                    <div class="diff-line ${line.type}">
                        <span class="line-number">${lineNum}</span>
                        <span class="line-content">${escapeHtml(line.content)}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // è°ƒç”¨æ€æºAPI
        async function callAPI(url, data) {
            try {
                const response = await fetch(API_BASE + url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }

        // è·å–ä¸Šæ–¹çš„è¶…çº§å—
        async function getSuperBlockAbove() {
            if (!widgetId) {
                throw new Error('æ— æ³•è·å–æŒ‚ä»¶ID');
            }

            // è·å–æŒ‚ä»¶çš„çˆ¶å—
            const widgetBlock = await callAPI('/api/block/getBlockInfo', { id: widgetId });
            if (!widgetBlock.data) {
                throw new Error('æ— æ³•è·å–æŒ‚ä»¶å—ä¿¡æ¯');
            }

            // è·å–çˆ¶æ–‡æ¡£çš„æ‰€æœ‰å­å—
            const parentId = widgetBlock.data.rootID;
            const docBlocks = await callAPI('/api/block/getChildBlocks', { id: parentId });
            
            if (!docBlocks.data) {
                throw new Error('æ— æ³•è·å–æ–‡æ¡£å—');
            }

            // æ‰¾åˆ°æŒ‚ä»¶å—çš„ä½ç½®ï¼Œç„¶åæ‰¾ä¸Šä¸€ä¸ªè¶…çº§å—
            const blocks = docBlocks.data;
            const widgetIndex = blocks.findIndex(b => b.id === widgetId);
            
            if (widgetIndex === -1) {
                throw new Error('æ— æ³•æ‰¾åˆ°æŒ‚ä»¶å—');
            }

            // ä»æŒ‚ä»¶å¾€ä¸Šæ‰¾ç¬¬ä¸€ä¸ªè¶…çº§å—
            for (let i = widgetIndex - 1; i >= 0; i--) {
                if (blocks[i].type === 's') {  // 's' è¡¨ç¤ºè¶…çº§å—
                    return blocks[i];
                }
            }

            throw new Error('åœ¨æŒ‚ä»¶ä¸Šæ–¹æœªæ‰¾åˆ°è¶…çº§å—');
        }

        // æå–è¶…çº§å—ä¸­çš„å·¦å³ä»£ç å—å†…å®¹
        async function extractCodeBlocks(superBlockId) {
            const childBlocks = await callAPI('/api/block/getChildBlocks', { id: superBlockId });
            
            if (!childBlocks.data || childBlocks.data.length < 2) {
                throw new Error('è¶…çº§å—ä¸­ä»£ç å—æ•°é‡ä¸è¶³ï¼ˆéœ€è¦è‡³å°‘2ä¸ªï¼‰');
            }

            const codeBlocks = childBlocks.data.filter(block => block.type === 'c');  // 'c' è¡¨ç¤ºä»£ç å—
            
            if (codeBlocks.length < 2) {
                throw new Error('è¶…çº§å—ä¸­æœªæ‰¾åˆ°è¶³å¤Ÿçš„ä»£ç å—ï¼ˆéœ€è¦è‡³å°‘2ä¸ªï¼‰');
            }

            // è·å–å‰ä¸¤ä¸ªä»£ç å—çš„å†…å®¹
            const leftBlock = await callAPI('/api/block/getBlockKramdown', { id: codeBlocks[0].id });
            const rightBlock = await callAPI('/api/block/getBlockKramdown', { id: codeBlocks[1].id });

            // ä»Kramdownä¸­æå–ä»£ç å†…å®¹
            const leftContent = extractCodeContent(leftBlock.data.kramdown);
            const rightContent = extractCodeContent(rightBlock.data.kramdown);

            return { left: leftContent, right: rightContent };
        }

        // ä»Kramdownæå–ä»£ç å†…å®¹
        function extractCodeContent(kramdown) {
            // åŒ¹é…ä»£ç å—: ```language\ncode\n```
            const match = kramdown.match(/```[\s\S]*?\n([\s\S]*?)```/);
            if (match && match[1]) {
                return match[1].trim();
            }
            return '';
        }

        // åŠ è½½å¹¶æ˜¾ç¤ºdiff
        async function loadAndShowDiff() {
            try {
                document.getElementById('diffContent').innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½...</div>';
                
                const superBlock = await getSuperBlockAbove();
                const { left, right } = await extractCodeBlocks(superBlock.id);

                if (!left && !right) {
                    showStatus('ä»£ç å—ä¸ºç©ºï¼Œè¯·æ·»åŠ ä»£ç å†…å®¹', 'error');
                    document.getElementById('diffContent').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <p>ä»£ç å—ä¸ºç©º</p>
                        </div>
                    `;
                    return;
                }

                const diffResult = computeDiff(left, right);
                renderDiff(diffResult);
                showStatus('å·®å¼‚å¯¹æ¯”å·²æ›´æ–°', 'success');

            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                showStatus(error.message, 'error');
                document.getElementById('diffContent').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <p>åŠ è½½å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }

        // æ’å…¥å¯¹æ¯”æ¨¡æ¿
        async function insertComparisonTemplate() {
            try {
                if (!widgetId) {
                    throw new Error('æ— æ³•è·å–æŒ‚ä»¶ID');
                }

                // è·å–æŒ‚ä»¶çš„çˆ¶å—ä¿¡æ¯
                const widgetBlock = await callAPI('/api/block/getBlockInfo', { id: widgetId });
                if (!widgetBlock.data) {
                    throw new Error('æ— æ³•è·å–æŒ‚ä»¶å—ä¿¡æ¯');
                }

                // è·å–çˆ¶æ–‡æ¡£çš„æ‰€æœ‰å­å—
                const parentId = widgetBlock.data.rootID;
                const docBlocks = await callAPI('/api/block/getChildBlocks', { id: parentId });
                
                if (!docBlocks.data) {
                    throw new Error('æ— æ³•è·å–æ–‡æ¡£å—');
                }

                // æ‰¾åˆ°æŒ‚ä»¶å—çš„ä½ç½®
                const blocks = docBlocks.data;
                const widgetIndex = blocks.findIndex(b => b.id === widgetId);
                
                if (widgetIndex === -1) {
                    throw new Error('æ— æ³•æ‰¾åˆ°æŒ‚ä»¶å—');
                }

                // åˆ›å»ºè¶…çº§å—çš„Markdown
                const template = `{{{row
\`\`\`
åŸå§‹ä»£ç 
åœ¨è¿™é‡Œè¾“å…¥ç¬¬ä¸€æ®µä»£ç 
\`\`\`

\`\`\`
ä¿®æ”¹åä»£ç 
åœ¨è¿™é‡Œè¾“å…¥ç¬¬äºŒæ®µä»£ç 
\`\`\`
}}}`;

                // åœ¨æŒ‚ä»¶å‰æ’å…¥è¶…çº§å—
                // å¦‚æœæŒ‚ä»¶æ˜¯ç¬¬ä¸€ä¸ªå—ï¼Œæ’å…¥åˆ°çˆ¶å—çš„ç¬¬ä¸€ä¸ªä½ç½®
                // å¦åˆ™æ’å…¥åˆ°å‰ä¸€ä¸ªå—ä¹‹å
                let insertParams;
                if (widgetIndex === 0) {
                    insertParams = {
                        dataType: 'markdown',
                        data: template,
                        parentID: parentId
                    };
                } else {
                    const previousBlockId = blocks[widgetIndex - 1].id;
                    insertParams = {
                        dataType: 'markdown',
                        data: template,
                        previousID: previousBlockId
                    };
                }

                await callAPI('/api/block/insertBlock', insertParams);

                showStatus('æ¨¡æ¿å·²æ’å…¥åˆ°æŒ‚ä»¶ä¸Šæ–¹', 'success');
                
                // å»¶è¿Ÿåˆ·æ–°ä»¥ç­‰å¾…å—åˆ›å»ºå®Œæˆ
                setTimeout(() => {
                    loadAndShowDiff();
                }, 1000);

            } catch (error) {
                console.error('æ’å…¥æ¨¡æ¿å¤±è´¥:', error);
                showStatus('æ’å…¥æ¨¡æ¿å¤±è´¥: ' + error.message, 'error');
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('insertBtn').addEventListener('click', insertComparisonTemplate);
        document.getElementById('refreshBtn').addEventListener('click', loadAndShowDiff);

        // è°ƒè¯•ä¿¡æ¯
        console.log('Widget ID:', widgetId);
        console.log('API Base:', API_BASE);

        // è‡ªåŠ¨åŠ è½½ - å¢åŠ å»¶è¿Ÿä»¥ç¡®ä¿DOMå®Œå…¨åŠ è½½
        setTimeout(() => {
            if (widgetId) {
                loadAndShowDiff();
            } else {
                console.error('Widget IDæœªæ‰¾åˆ°ï¼Œæ— æ³•è‡ªåŠ¨åŠ è½½');
                showStatus('æ— æ³•è·å–æŒ‚ä»¶IDï¼Œè¯·æ£€æŸ¥æŒ‚ä»¶é…ç½®', 'error');
            }
        }, 1000);

        // å®šæœŸè‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰
        setInterval(() => {
            if (widgetId) {
                loadAndShowDiff();
            }
        }, 5000);
    </script>
</body>
</html>
