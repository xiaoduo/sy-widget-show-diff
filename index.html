<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Show Diff Widget</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            width: 100%;
        }

        .widget-container {
            width: 100%;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .control-panel {
            display: flex;
            align-items: center;
            margin-left: 16px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            margin-right: 8px;
            white-space: nowrap;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .diff-container {
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .diff-header {
            padding: 12px 16px;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .diff-header-title {
            flex: 1;
        }

        .diff-header-status {
            font-size: 12px;
            font-weight: normal;
            color: #28a745;
            margin-left: 16px;
        }

        .auto-update-control {
            display: flex;
            align-items: center;
            font-size: 12px;
            font-weight: normal;
            color: #495057;
        }

        .auto-update-control input[type="checkbox"] {
            margin-right: 4px;
            cursor: pointer;
        }

        .auto-update-control label {
            cursor: pointer;
            user-select: none;
        }

        .diff-content {
            padding: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-x: auto;
        }

        .diff-line {
            display: flex;
            min-height: 20px;
            padding: 2px 0;
        }

        .line-number {
            min-width: 50px;
            padding: 0 12px;
            text-align: right;
            color: rgba(27,31,35,0.3);
            user-select: none;
            flex-shrink: 0;
        }

        .line-content {
            flex: 1;
            padding: 0 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .char-diff {
            background: rgba(255, 200, 0, 0.5);
            font-weight: 700;
            padding: 1px 2px;
            border-radius: 2px;
        }

        .diff-line.added .char-diff {
            background: rgba(34, 134, 58, 0.6);
            color: #0d4b1a;
        }

        .diff-line.removed .char-diff {
            background: rgba(215, 58, 73, 0.6);
            color: #6b1018;
        }

        .diff-line.added {
            background: #e6ffed;
        }

        .diff-line.added .line-content {
            color: #24292e;
        }

        .diff-line.added::before {
            content: '+';
            color: #22863a;
            padding: 0 8px;
            font-weight: bold;
            min-width: 24px;
            display: inline-block;
            text-align: center;
        }

        .diff-line.removed {
            background: #ffeef0;
        }

        .diff-line.removed .line-content {
            color: #24292e;
        }

        .diff-line.removed::before {
            content: '-';
            color: #d73a49;
            padding: 0 8px;
            font-weight: bold;
            min-width: 24px;
            display: inline-block;
            text-align: center;
        }

        .diff-line.unchanged {
            background: white;
        }

        .diff-line.unchanged::before {
            content: ' ';
            padding: 0 8px;
            min-width: 24px;
            display: inline-block;
            text-align: center;
        }

        .empty-state {
            padding: 40px;
            text-align: center;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .status-message {
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 4px;
            font-size: 14px;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .loading {
            padding: 20px;
            text-align: center;
            color: #6c757d;
        }

        .diff-stats {
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
            color: #495057;
        }

        .diff-stats span {
            margin-right: 16px;
        }

        .added-count {
            color: #28a745;
            font-weight: 600;
        }

        .removed-count {
            color: #dc3545;
            font-weight: 600;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .diff-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .diff-content::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 4px;
        }

        .diff-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .diff-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Firefox æ»šåŠ¨æ¡æ ·å¼ */
        .diff-content {
            scrollbar-width: thin;
            scrollbar-color: #888 #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div id="statusMessage"></div>
        
        <div class="diff-container">
            <div class="diff-header">
                <span class="diff-header-title">å·®å¼‚å¯¹æ¯”ç»“æœ</span>
                <span id="headerStatus" class="diff-header-status"></span>
                <div class="control-panel">
                    <button id="insertBtn" class="btn btn-primary">ğŸ“ æ’å…¥å¯¹æ¯”æ¨¡æ¿</button>
                    <button id="refreshBtn" class="btn btn-success">ğŸ”„ åˆ·æ–°å¯¹æ¯”</button>
                </div>
                <div class="auto-update-control">
                    <input type="checkbox" id="autoUpdateCheckbox" checked>
                    <label for="autoUpdateCheckbox">è‡ªåŠ¨æ›´æ–°</label>
                </div>
            </div>
            <div id="diffContent" class="diff-content">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“Š</div>
                    <p>ç­‰å¾…åŠ è½½å¯¹æ¯”æ•°æ®...</p>
                    <p style="font-size: 12px; color: #adb5bd;">è¯·åœ¨æ­¤æŒ‚ä»¶ä¸Šæ–¹æ’å…¥å¯¹æ¯”æ¨¡æ¿æˆ–æ‰‹åŠ¨åˆ›å»ºåŒ…å«å·¦å³ä»£ç å—çš„è¶…çº§å—</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è·å–æŒ‚ä»¶æ‰€åœ¨å—çš„ID
        const widgetId = window.frameElement?.parentElement?.parentElement?.dataset?.nodeId;
        const API_BASE = 'http://127.0.0.1:6806';

        // Myers diff algorithm implementation
        function computeDiff(text1, text2) {
            const lines1 = text1.split('\n');
            const lines2 = text2.split('\n');
            const n = lines1.length;
            const m = lines2.length;
            const max = n + m;
            const v = {};
            const trace = [];

            v[1] = 0;
            for (let d = 0; d <= max; d++) {
                trace.push({ ...v });
                for (let k = -d; k <= d; k += 2) {
                    let x;
                    if (k === -d || (k !== d && v[k - 1] < v[k + 1])) {
                        x = v[k + 1];
                    } else {
                        x = v[k - 1] + 1;
                    }
                    let y = x - k;
                    while (x < n && y < m && lines1[x] === lines2[y]) {
                        x++;
                        y++;
                    }
                    v[k] = x;
                    if (x >= n && y >= m) {
                        return buildDiff(lines1, lines2, trace, d);
                    }
                }
            }
            return buildDiff(lines1, lines2, trace, max);
        }

        function buildDiff(lines1, lines2, trace, d) {
            const diff = [];
            let x = lines1.length;
            let y = lines2.length;

            for (let depth = d; depth >= 0; depth--) {
                const v = trace[depth];
                const k = x - y;
                let prevK;
                if (k === -depth || (k !== depth && v[k - 1] < v[k + 1])) {
                    prevK = k + 1;
                } else {
                    prevK = k - 1;
                }
                const prevX = v[prevK];
                const prevY = prevX - prevK;

                while (x > prevX && y > prevY) {
                    diff.unshift({
                        type: 'unchanged',
                        content: lines1[x - 1],
                        oldLine: x,
                        newLine: y
                    });
                    x--;
                    y--;
                }

                if (depth > 0) {
                    if (x > prevX) {
                        diff.unshift({
                            type: 'removed',
                            content: lines1[x - 1],
                            oldLine: x,
                            newLine: null,
                            oldContent: lines1[x - 1],
                            newContent: y < lines2.length ? lines2[y] : null
                        });
                        x--;
                    } else if (y > prevY) {
                        diff.unshift({
                            type: 'added',
                            content: lines2[y - 1],
                            oldLine: null,
                            newLine: y,
                            oldContent: x < lines1.length ? lines1[x] : null,
                            newContent: lines2[y - 1]
                        });
                        y--;
                    }
                }
            }
            return diff;
        }

        // Character-level diff for modified lines
        function getCharDiff(oldStr, newStr) {
            if (!oldStr || !newStr) return { old: oldStr || '', new: newStr || '' };
            
            const oldChars = oldStr.split('');
            const newChars = newStr.split('');
            const n = oldChars.length;
            const m = newChars.length;
            
            // Find common prefix
            let prefixLen = 0;
            while (prefixLen < n && prefixLen < m && oldChars[prefixLen] === newChars[prefixLen]) {
                prefixLen++;
            }
            
            // Find common suffix
            let suffixLen = 0;
            while (suffixLen < n - prefixLen && suffixLen < m - prefixLen && 
                   oldChars[n - 1 - suffixLen] === newChars[m - 1 - suffixLen]) {
                suffixLen++;
            }
            
            const prefix = escapeHtml(oldStr.substring(0, prefixLen));
            const suffix = escapeHtml(oldStr.substring(n - suffixLen));
            const oldMiddle = oldStr.substring(prefixLen, n - suffixLen);
            const newMiddle = newStr.substring(prefixLen, m - suffixLen);
            
            const oldResult = prefix + 
                (oldMiddle ? `<span class="char-diff">${escapeHtml(oldMiddle)}</span>` : '') + 
                suffix;
            const newResult = prefix + 
                (newMiddle ? `<span class="char-diff">${escapeHtml(newMiddle)}</span>` : '') + 
                suffix;
            
            return { old: oldResult, new: newResult };
        }

        // æ¸²æŸ“diffç»“æœ
        function renderDiff(diffResult) {
            const container = document.getElementById('diffContent');
            
            if (diffResult.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âœ…</div>
                        <p>ä¸¤æ®µä»£ç å®Œå…¨ç›¸åŒ</p>
                    </div>
                `;
                return;
            }

            // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            const stats = diffResult.reduce((acc, line) => {
                if (line.type === 'added') acc.added++;
                if (line.type === 'removed') acc.removed++;
                return acc;
            }, { added: 0, removed: 0 });

            let html = `
                <div class="diff-stats">
                    <span class="added-count">+${stats.added} æ–°å¢</span>
                    <span class="removed-count">-${stats.removed} åˆ é™¤</span>
                </div>
            `;

            // Improved grouping: handle multiple consecutive removed/added blocks
            const grouped = [];
            let i = 0;
            
            while (i < diffResult.length) {
                const curr = diffResult[i];
                
                if (curr.type === 'unchanged') {
                    grouped.push(curr);
                    i++;
                    continue;
                }
                
                // Collect consecutive removed lines
                const removedBlock = [];
                while (i < diffResult.length && diffResult[i].type === 'removed') {
                    removedBlock.push(diffResult[i]);
                    i++;
                }
                
                // Collect consecutive added lines
                const addedBlock = [];
                while (i < diffResult.length && diffResult[i].type === 'added') {
                    addedBlock.push(diffResult[i]);
                    i++;
                }
                
                // If we have both removed and added lines, apply char-level diff
                if (removedBlock.length > 0 && addedBlock.length > 0) {
                    const maxLines = Math.max(removedBlock.length, addedBlock.length);
                    
                    for (let j = 0; j < maxLines; j++) {
                        if (j < removedBlock.length && j < addedBlock.length) {
                            // Both lines exist - apply char diff
                            const charDiff = getCharDiff(removedBlock[j].content, addedBlock[j].content);
                            grouped.push({
                                type: 'removed',
                                content: charDiff.old,
                                oldLine: removedBlock[j].oldLine,
                                isHtml: true
                            });
                            grouped.push({
                                type: 'added',
                                content: charDiff.new,
                                newLine: addedBlock[j].newLine,
                                isHtml: true
                            });
                        } else if (j < removedBlock.length) {
                            // Only removed line exists
                            grouped.push(removedBlock[j]);
                        } else {
                            // Only added line exists
                            grouped.push(addedBlock[j]);
                        }
                    }
                } else {
                    // Only one type exists - add them as is
                    grouped.push(...removedBlock);
                    grouped.push(...addedBlock);
                }
            }

            grouped.forEach(line => {
                const lineNum = line.oldLine || line.newLine || '';
                const content = line.isHtml ? line.content : escapeHtml(line.content);
                html += `
                    <div class="diff-line ${line.type}">
                        <span class="line-number">${lineNum}</span>
                        <span class="line-content">${content}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯ï¼ˆåœ¨headerä¸­æ˜¾ç¤ºï¼‰
        function showHeaderStatus(message) {
            const headerStatus = document.getElementById('headerStatus');
            headerStatus.textContent = message;
            setTimeout(() => {
                headerStatus.textContent = '';
            }, 3000);
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼ˆä½¿ç”¨æ—§çš„å¼¹å‡ºæ ·å¼ï¼‰
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // è°ƒç”¨æ€æºAPI
        async function callAPI(url, data) {
            try {
                const response = await fetch(API_BASE + url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }

        // è·å–ä¸Šæ–¹çš„è¶…çº§å—
        async function getSuperBlockAbove() {
            if (!widgetId) {
                throw new Error('æ— æ³•è·å–æŒ‚ä»¶ID');
            }

            // è·å–æŒ‚ä»¶çš„çˆ¶å—
            const widgetBlock = await callAPI('/api/block/getBlockInfo', { id: widgetId });
            if (!widgetBlock.data) {
                throw new Error('æ— æ³•è·å–æŒ‚ä»¶å—ä¿¡æ¯');
            }

            // è·å–çˆ¶æ–‡æ¡£çš„æ‰€æœ‰å­å—
            const parentId = widgetBlock.data.rootID;
            const docBlocks = await callAPI('/api/block/getChildBlocks', { id: parentId });
            
            if (!docBlocks.data) {
                throw new Error('æ— æ³•è·å–æ–‡æ¡£å—');
            }

            // æ‰¾åˆ°æŒ‚ä»¶å—çš„ä½ç½®ï¼Œç„¶åæ‰¾ä¸Šä¸€ä¸ªè¶…çº§å—
            const blocks = docBlocks.data;
            const widgetIndex = blocks.findIndex(b => b.id === widgetId);
            
            if (widgetIndex === -1) {
                throw new Error('æ— æ³•æ‰¾åˆ°æŒ‚ä»¶å—');
            }

            // ä»æŒ‚ä»¶å¾€ä¸Šæ‰¾ç¬¬ä¸€ä¸ªè¶…çº§å—
            for (let i = widgetIndex - 1; i >= 0; i--) {
                if (blocks[i].type === 's') {  // 's' è¡¨ç¤ºè¶…çº§å—
                    return blocks[i];
                }
            }

            throw new Error('åœ¨æŒ‚ä»¶ä¸Šæ–¹æœªæ‰¾åˆ°è¶…çº§å—');
        }

        // æå–è¶…çº§å—ä¸­çš„å·¦å³ä»£ç å—å†…å®¹
        async function extractCodeBlocks(superBlockId) {
            const childBlocks = await callAPI('/api/block/getChildBlocks', { id: superBlockId });
            
            if (!childBlocks.data || childBlocks.data.length < 2) {
                throw new Error('è¶…çº§å—ä¸­ä»£ç å—æ•°é‡ä¸è¶³ï¼ˆéœ€è¦è‡³å°‘2ä¸ªï¼‰');
            }

            const codeBlocks = childBlocks.data.filter(block => block.type === 'c');  // 'c' è¡¨ç¤ºä»£ç å—
            
            if (codeBlocks.length < 2) {
                throw new Error('è¶…çº§å—ä¸­æœªæ‰¾åˆ°è¶³å¤Ÿçš„ä»£ç å—ï¼ˆéœ€è¦è‡³å°‘2ä¸ªï¼‰');
            }

            // è·å–å‰ä¸¤ä¸ªä»£ç å—çš„å†…å®¹
            const leftBlock = await callAPI('/api/block/getBlockKramdown', { id: codeBlocks[0].id });
            const rightBlock = await callAPI('/api/block/getBlockKramdown', { id: codeBlocks[1].id });

            // ä»Kramdownä¸­æå–ä»£ç å†…å®¹
            const leftContent = extractCodeContent(leftBlock.data.kramdown);
            const rightContent = extractCodeContent(rightBlock.data.kramdown);

            return { left: leftContent, right: rightContent };
        }

        // ä»Kramdownæå–ä»£ç å†…å®¹
        function extractCodeContent(kramdown) {
            // åŒ¹é…ä»£ç å—: ```language\ncode\n```
            const match = kramdown.match(/```[\s\S]*?\n([\s\S]*?)```/);
            if (match && match[1]) {
                return match[1].trim();
            }
            return '';
        }

        // åŠ è½½å¹¶æ˜¾ç¤ºdiff
        async function loadAndShowDiff() {
            try {
                document.getElementById('diffContent').innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½...</div>';
                
                const superBlock = await getSuperBlockAbove();
                const { left, right } = await extractCodeBlocks(superBlock.id);

                if (!left && !right) {
                    showStatus('ä»£ç å—ä¸ºç©ºï¼Œè¯·æ·»åŠ ä»£ç å†…å®¹', 'error');
                    document.getElementById('diffContent').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <p>ä»£ç å—ä¸ºç©º</p>
                        </div>
                    `;
                    return;
                }

                const diffResult = computeDiff(left, right);
                renderDiff(diffResult);
                showHeaderStatus('å·²æ›´æ–°');

            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                showStatus(error.message, 'error');
                document.getElementById('diffContent').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <p>åŠ è½½å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }

        // æ’å…¥å¯¹æ¯”æ¨¡æ¿
        async function insertComparisonTemplate() {
            try {
                if (!widgetId) {
                    throw new Error('æ— æ³•è·å–æŒ‚ä»¶ID');
                }

                // è·å–æŒ‚ä»¶çš„çˆ¶å—ä¿¡æ¯
                const widgetBlock = await callAPI('/api/block/getBlockInfo', { id: widgetId });
                if (!widgetBlock.data) {
                    throw new Error('æ— æ³•è·å–æŒ‚ä»¶å—ä¿¡æ¯');
                }

                // è·å–çˆ¶æ–‡æ¡£çš„æ‰€æœ‰å­å—
                const parentId = widgetBlock.data.rootID;
                const docBlocks = await callAPI('/api/block/getChildBlocks', { id: parentId });
                
                if (!docBlocks.data) {
                    throw new Error('æ— æ³•è·å–æ–‡æ¡£å—');
                }

                // æ‰¾åˆ°æŒ‚ä»¶å—çš„ä½ç½®
                const blocks = docBlocks.data;
                const widgetIndex = blocks.findIndex(b => b.id === widgetId);
                
                if (widgetIndex === -1) {
                    throw new Error('æ— æ³•æ‰¾åˆ°æŒ‚ä»¶å—');
                }

                // åˆ›å»ºè¶…çº§å—çš„Markdown
                const template = `{{{row
\`\`\`
åŸå§‹ä»£ç 
åœ¨è¿™é‡Œè¾“å…¥ç¬¬ä¸€æ®µä»£ç 
\`\`\`

\`\`\`
ä¿®æ”¹åä»£ç 
åœ¨è¿™é‡Œè¾“å…¥ç¬¬äºŒæ®µä»£ç 
\`\`\`
}}}`;

                // åœ¨æŒ‚ä»¶å‰æ’å…¥è¶…çº§å—
                // å¦‚æœæŒ‚ä»¶æ˜¯ç¬¬ä¸€ä¸ªå—ï¼Œæ’å…¥åˆ°çˆ¶å—çš„ç¬¬ä¸€ä¸ªä½ç½®
                // å¦åˆ™æ’å…¥åˆ°å‰ä¸€ä¸ªå—ä¹‹å
                let insertParams;
                if (widgetIndex === 0) {
                    insertParams = {
                        dataType: 'markdown',
                        data: template,
                        parentID: parentId
                    };
                } else {
                    const previousBlockId = blocks[widgetIndex - 1].id;
                    insertParams = {
                        dataType: 'markdown',
                        data: template,
                        previousID: previousBlockId
                    };
                }

                await callAPI('/api/block/insertBlock', insertParams);

                showStatus('æ¨¡æ¿å·²æ’å…¥åˆ°æŒ‚ä»¶ä¸Šæ–¹', 'success');
                
                // å»¶è¿Ÿåˆ·æ–°ä»¥ç­‰å¾…å—åˆ›å»ºå®Œæˆ
                setTimeout(() => {
                    loadAndShowDiff();
                }, 1000);

            } catch (error) {
                console.error('æ’å…¥æ¨¡æ¿å¤±è´¥:', error);
                showStatus('æ’å…¥æ¨¡æ¿å¤±è´¥: ' + error.message, 'error');
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('insertBtn').addEventListener('click', insertComparisonTemplate);
        document.getElementById('refreshBtn').addEventListener('click', loadAndShowDiff);

        // è°ƒè¯•ä¿¡æ¯
        console.log('Widget ID:', widgetId);
        console.log('API Base:', API_BASE);

        // è‡ªåŠ¨åŠ è½½ - å¢åŠ å»¶è¿Ÿä»¥ç¡®ä¿DOMå®Œå…¨åŠ è½½
        setTimeout(() => {
            if (widgetId) {
                loadAndShowDiff();
            } else {
                console.error('Widget IDæœªæ‰¾åˆ°ï¼Œæ— æ³•è‡ªåŠ¨åŠ è½½');
                showStatus('æ— æ³•è·å–æŒ‚ä»¶IDï¼Œè¯·æ£€æŸ¥æŒ‚ä»¶é…ç½®', 'error');
            }
        }, 1000);

        // å®šæœŸè‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰ï¼Œæ ¹æ®checkboxçŠ¶æ€
        setInterval(() => {
            const autoUpdateCheckbox = document.getElementById('autoUpdateCheckbox');
            if (widgetId && autoUpdateCheckbox && autoUpdateCheckbox.checked) {
                loadAndShowDiff();
            }
        }, 5000);
    </script>
</body>
</html>
